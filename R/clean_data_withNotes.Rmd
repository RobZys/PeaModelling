---
title: '20190805'
author: "Jian"
date: "05/08/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pkgs}
library(readxl)
library(tidyverse)
library(lubridate)
source("functions.R")

replace_0 <- function(x) {x = ifelse(x == 0, NA, x);x}

```

```{r raw data}
url <- "https://iplant.plantandfood.co.nz/project/P442060-13/_layouts/15/WopiFrame.aspx?sourcedoc=/project/P442060-13/Research/18_19_SAE_pea_protein_managment.xlsx&action=default"
Source_HB = "RAW_HB"
Source_Linc = "RAW_Lincoln"

# Use the function scrape_list to extract the table from iPlant as a dataframe.
df_lincoln <- scrape_xl(url = url, sheet = Source_Linc, skip = 2)
df_HB <- scrape_xl(url = url, sheet = Source_HB, skip = 2)
# url <- "https://iplant.plantandfood.co.nz/project/I180822/Research/Forms/AllItems.aspx"
# PFRTextMiner::scrape_file(url, dest = "./Data/")
# PFRTextMiner::scrape_list(url) # not working

# repair the name and glimpse the structure of the data
df_lincoln %>% 
  mutate(Site = Source_Linc) %>%
  as_tibble(.name_repair = "universal") %>% 
  glimpse()

# vars start with N are not numeric 
# need to replace the `-` by NA and change type
LN <- df_lincoln %>% 
  as_tibble(.name_repair = "universal") %>% 
  mutate(Index = "LN") %>%
  mutate_at(vars(starts_with("N_")), as.double)

HB <- df_HB %>% 
  as_tibble(.name_repair = "universal") %>% 
  mutate(Index = Source_HB,
         maturepodFW = as.numeric(maturepodFW),
         maturepodDW = as.numeric(maturepodDW)) %>% 
  mutate_at(vars(starts_with("N_")), as.double)



# combined_raw <- bind_rows(LN, HB) %>% 
  # mutate(Site = gsub("RAW\\_","", Site))

```

# fix lincoln variable names 

```{r lincoln variable names }
LN %>% 
  colnames()
```

[Protocol](https://iplant.plantandfood.co.nz/project/P442060-13/_layouts/15/WopiFrame2.aspx?sourcedoc=/project/P442060-13/Research/Protocol_plant_protein_2018-19.docx&action=default)
[Variable Names](https://iplant.plantandfood.co.nz/project/P442060-13/_layouts/15/WopiFrame.aspx?sourcedoc=/project/P442060-13/Research/18_19_SAE_pea_protein_managment.xlsx&action=default)

_note_:

1. **could ignore the Final_Pod.PeaFW because it is supposed to be the sum of Final_podFW  and Final_grainFW**

2. **no 5 plants partitioning at the final harvest**

##Figure out the mismatch variable names 

```{r}


setdiff(colnames(LN), colnames(HB))
setdiff(colnames(HB), colnames(LN))

```



```{r}
LN_renamed <- LN %>% 
  mutate(deadFW = deadleafFW + deadstemFW, 
         deadDW = deadleafDW + deadstemDW, 
         N_Content_Dead = N_Content_Dead_Stem + N_Content_Dead_Leaf,
         Pea_num = GreenPeaNum + MaturePeaNum,
         Pod_num = Final_Pod_num) %>% 
  select( -Final_Pod.PeaFW, -contains("PeaNum"), -Final_Pod_num, -contains("deadleaf"), -contains("deadstem"), -N_Content_Dead_Stem, -N_Content_Dead_Leaf)
  

HB_renamed <- HB %>% 
  rename(greengrainFW = grainFW,
         greengrainDW = grainDW,
         Final_ResidueSubFW = Final_residueFW,
         Final_ResidueSubDW = Final_residueDW) %>% 
  mutate_if(is.numeric, ~ replace_na(., 0)) %>%  # na causes trouble to calcualte final component 
  mutate(TFW = ifelse(TFW == 0, TFW2, TFW),
         Final_grainFW = ifelse(Final_grainFW_hb2 == 0, Final_grainFW, Final_grainFW_hb2 + Final_grainSproutedFW )) %>% 
  select(-TFW2, -Final_grainFW_hb2)

setdiff(colnames(LN_renamed), colnames(HB_renamed))

setdiff(colnames(HB_renamed), colnames(LN_renamed))

combined <- bind_rows(LN_renamed, HB_renamed)  %>% 
  rename(Site = Index) %>% 
  mutate(Site = gsub("RAW_","", Site),
         Date = ymd(Date))# date should be in NZ format
 

```

##### extra colnames from HB, not present in Lincoln 

**"final_grainsprouted"   **
**"final_grainsproutedfw" **
**"final_greenpodnumber" **
**"final_greenpodfw"     **
**"final_greenpoddw"**
**"final_grainsprouteddw"**

# METADATA 
```{r}
metadata <- combined %>% 
  select(Site, Date, Plot, Block, Trt_num, Trt_name, Cultivar, Sowing_Date, N_timing) %>% 
  distinct() %>% 
  data.table::as.data.table()
data.table::setkey(metadata, Site, Date, Plot)
anyDuplicated(metadata)


```

# plant organ to whole plant 

```{r necessary variables}
whole_plant <- combined %>% 
  mutate_if(is.numeric, ~ replace_na(.,0)) %>%  # replace NAs by 0 for adding organs up
  mutate(# subsample fresh/dry weight 
         SSFW = ifelse(SSFW == 0, Final_ResidueSubFW + Final_podFW + Final_grainFW, SSFW),
         Final_grainDW = (Final_100grainDW/100) * Final_GrainCount, # this is the problem that makes the graindw is greater than fw
         SSDW = ifelse(SSDW == 0, (Final_ResidueSubDW + Final_podDW + Final_grainDW),SSDW),
    
         # partitioning
         partFW = greenleafFW + greenstemFW + deadFW + greenpodFW + greengrainFW + maturepodFW + maturegrainFW,
         partDW = greenleafDW + greenstemDW + deadDW + greenpodDW + greengrainDW + maturepodDW + maturegrainDW,
         
         # green area for light interception
         green_Area = Leaf_area + Stem_area + Pod_area,
         
         # grain weight
         grainFW = greengrainFW + maturegrainFW,
         grainDW = greengrainDW + maturegrainDW,
         grainFW = ifelse(grainFW == 0, Final_grainFW, grainFW),
         grainDW = ifelse(grainDW == 0, Final_grainDW, grainDW)

  ) 

whole_plant %>% 
  select(Site, Date, Event, Block, Plot, Trt_name, HA, PP, TFW, SSFW, SSDW, partFW, partDW, green_Area) %>% 
  ggplot(aes(SSFW, SSDW, color = Event))+
  geom_point()+
  facet_grid(~ Site) 
whole_plant %>% 
  ggplot(aes(partFW, partDW, color = Event))+
  geom_point()+
  facet_grid(~ Site) 
```

**Harvest 3 in HB has no SSDW**
Need to calculate from the Part dm percentage




```{r overall dm percentage}

whole_plant %>% 
  mutate(partDM_PC = partDW/partFW,
         SSDM_PC = SSDW/ SSFW) %>%  
  ggplot(aes(partDM_PC, SSDM_PC))+
  geom_point()+
  geom_smooth( method = "lm", se = F) + 
  facet_grid(~ Site) +
  geom_text(aes(label = Plot), nudge_y = 0.05, check_overlap = T)
whole_plant %>% 
  mutate(partDM_PC = partDW/partFW,
         SSDM_PC = SSDW/ SSFW) %>% 
  filter(Plot == 11) %>% 
  select(SSDM_PC, partDM_PC, Plot, Site, Date, Event)
```

**the overall whole plant dry matter percentage in partitioning sample generally agrees with the subsample dry mater percentage. But plot 17 in Lincoln may need to pay attention**

_note_:
1. Mike double checked plot 17, the data looks good now. 
2. Issy also updated some values, which reduce the variability of the data. 

**plot 17 seems to have trouble to procude any green leaf and stem when harvested at 2019-01-21**

**plot 1, 5 and 11 in HB have higher partDM percentage** 
11 and 5 are the same trt and cultivar but 1 is another cultivar. 
accept the variablity and proceed with cautions!!!

```{r checking errors}
whole_plant %>% 
  mutate(DM_pc = SSDW/SSFW * 100,
         DM_pc = ifelse(DM_pc == 0, partDW/partFW*100, DM_pc)) %>% 
  filter(DM_pc > 100) %>% 
  select(Site,Plot, Date, Event, starts_with("Final"), DM_pc) 
  
```

_note_

1. H7 plot21 final residuedw is greater(`277.1`) than fw(`235.5`) - need to double check - Issy checked and updated
2. SD1_final plot24 graindw is greater than grainfw due to the calculation method? average grain weight * graincount. 


## component data checking 

```{r}
colnames(whole_plant) %>% 
  grep("grain", x = ., value = T)

whole_plant %>% 
  mutate(grain_pc = grainDW/grainFW *100) %>% 
  filter(grain_pc > 100) %>% 
  select(Site, Date, Event, Plot, grainDW, grainFW, grain_pc)
```

```{r checking the parts}

# this should be in a function that can checking the pairs automatically
colnames(whole_plant) %>% 
  grep("leaf", x = ., value = T)
colnames(whole_plant) %>% 
  grep("stem", x = ., value = T)
dead_part = colnames(whole_plant) %>% 
  grep("dead", x = ., value = T)

whole_plant %>% 
  mutate(dead_pc = deadDW/deadFW *100) %>% 
  filter(dead_pc > 100) %>% 
  select(Site, Date, Event, Plot, deadDW, deadFW, dead_pc)

whole_plant %>% 
  mutate(stem_pc = greenstemDW/greenstemFW *100) %>% 
  filter(stem_pc > 100) %>% 
  select(Site, Date, Event, Plot, greenstemDW, greenstemFW, stem_pc)
whole_plant %>% 
  mutate(leaf_pc = greenleafDW/greenleafFW *100) %>% 
  filter(leaf_pc > 100) %>% 
  select(Site, Date, Event, Plot, greenleafDW, greenleafFW, leaf_pc)

```


## component calculation

**should I use partitioning sample weight to calculate the proportion of subsample in total sample or the subsample weight or both**


```{r overall treand checking}
whole_plant %>% 

  mutate(DM_pc = SSDW/SSFW ,
         DM_pc = ifelse(DM_pc == 0, partDW/partFW, DM_pc))%>% 
  ggplot(aes(as.Date(Date), DM_pc, color = Cultivar))+
  geom_jitter() +
  facet_grid(~ Site) +
  geom_text(aes(label = Plot), check_overlap = T, nudge_x = 0.5, nudge_y = -0.05)+
  scale_y_continuous(breaks = seq(0, 1, by = 0.2),
                     labels = scales::percent,
                     limits = c(0, 1.01),
                     expand = c(0,0)) +
  scale_x_date(date_labels = "%b %d")


```


**no values below 0 or above 100%**
```{r}
whole_plant <- whole_plant %>% 
  mutate_if(is.numeric, ~ replace_0(.)) %>% 
  mutate(Id = 1:n())


```

# lock everything into sqlite3

```{r}
# creat SQL3 and build the connection  ------------------------------------
con <- dbConnect(RSQLite::SQLite(),'../Data/Pea_data.sqlite3')
dbListTables(con)

# creat table to correct the type of variable -----------------------------

colnames(metadata)
dbExecute(con," CREATE TABLE `metadata` (
  `Site` TEXT NOT NULL,
  `Date` int NOT NULL,
  `Plot` int NOT NULL,
  `Block` int NOT NULL,
  `Trt_num` int NOT NULL,
  `Trt_name` TEXT NOT NULL,
  `Cultivar` TEXT NOT NULL,
  `Sowing_Date` TEXT NOT NULL,
  `N_timing` DOUBLE,
  PRIMARY KEY (Site, Date, Plot)
);
")

dbExecute(con,"CREATE TABLE `biomass` (
  `Site` TEXT,
  `Date` REAL,
  `Event` int NOT NULL,
  `Plot` int NOT NULL ,
  `Block` int NOT NULL,
  `Trt_num` int NOT NULL,
  `Trt_name` TEXT,
  `Cultivar` TEXT,
  `Sowing_Date` TEXT,
  `N_timing` DOUBLE,
  `HA` REAL,
  `PP` REAL,
  `TFW` REAL,
  `SSFW` REAL,
  `SSDW` REAL,
  `partFW` REAL,
  `greenleafFW` REAL,
  `greenstemFW` REAL,
  `greenpodFW` REAL,
  `maturepodFW` REAL,
  `greengrainFW` REAL,
  `maturegrainFW` REAL,
  `Leaf_area` REAL,
  `Stem_area` REAL,
  `Pod_area` REAL,
  `greenleafDW` REAL,
  `greenstemDW` REAL,
  `greenpodDW` REAL,
  `maturepodDW` REAL,
  `greengrainDW` REAL,
  `maturegrainDW` REAL,
  `Final_ResidueSubFW` REAL,
  `Final_podFW` REAL,
  `Final_grainFW` REAL,
  `Final_100grainFW` REAL,
  `Final_ResidueSubDW` REAL,
  `Final_podDW` REAL,
  `Final_100grainDW` REAL,
  `Final_GrainMoisture` REAL,
  `Final_GrainCount` REAL,
  `N_Content_Green_Leaf` REAL,
  `N_Content_Green_Stem` REAL,
  `N_Content_Green_Pod` REAL,
  `N_Content_Mat_Pod` REAL,
  `N_Content_Green_Grain` REAL,
  `N_Content_Mat_Grain` REAL,
  `N_Content_Residue` REAL,
  `deadFW` REAL,
  `deadDW` REAL,
  `N_Content_Dead` REAL,
  `Pea_num` REAL,
  `Pod_num` REAL,
  `Final_grainSprouted` REAL,
  `Final_grainSproutedFW` REAL,
  `Final_GreenPodNumber` REAL,
  `Final_GreenPodFW` REAL,
  `Final_greenPodDW` REAL,
  `Final_grainSproutedDW` REAL,
  `Final_grainDW` REAL,
  `partDW` REAL,
  `green_Area` REAL,
  `grainFW` REAL,
  `grainDW` REAL,
  `Id` int NOT NULL,
  PRIMARY KEY (Id)
);")

# dbWriteTable(con, name = "metadata", value = metadata, append=TRUE)

dbWriteTable(con, name = "biomass", value = whole_plant, append=TRUE)

DBI::dbDisconnect(con)
```


